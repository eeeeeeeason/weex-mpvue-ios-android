<template>
  <div id="find">
    <!-- 导航栏 -->
    <div class="navigator">
      <div class="showContentBtn" @click="changeBar(0)" :class="activeBar===0?'active':''">
        <span>发布会</span>
      </div>
      <div class="showContentBtn" @click="changeBar(1)" :class="activeBar===1?'active':''">
        <span>同城活动</span>
      </div>
    </div>
    <scroll class="wrapper" :data="soon_auction_ul" :pulldown="pulldown" @pulldown="loadNewsData" @scrollToEnd="loadNewsData"  v-show="activeBar===0">
      <div class="listContainer"  slot="header">
        <div class="newsItem" v-for="item in newsMsg" @click="toConference(item.id)" :key="item.id">
          <img :src="item.pic1"/>
          <p>
            <span class="introduce">{{item.name}}</span>
            <span class="time">{{item.createtime}}</span>
          </p>
        </div>
        <div class="weui-loadmore" v-if="!isNewsEnd">
          <div class="weui-loading"></div>
          <div class="weui-loadmore__tips">正在加载</div>
        </div>
        <div class="loadEnd weui-loadmore__tips" v-else>---- 加载完毕 ----</div>
      </div>
    </scroll>
  <!-- 同城活动内容栏 -->
    <scroll class="wrapper" @scrollToEnd="getCampaignList"  v-show="activeBar===1">
      <div class="listContainer city"  slot="header">
        <div class="newsItem" v-for="item in campaignMsg" @click="toEventDetail(item.id)" :key="item.id">
          <img :src="item.pic1"/>
          <div class="title">
            <p class="introduce">{{item.name}}<span class="yellow"  v-if="item.status>=3">活动已结束</span><span class="pink"  v-if="item.status===2">进行中</span><span class="blue" v-if="item.status===1">报名中</span></p>
          </div>
          <p>
            <span class="introduce name pink">{{item.regnumber}}人已报名</span>
            <span class="time">{{item.regstarttime}}</span>
          </p>
        </div>
        <div class="weui-loadmore" v-if="!isCampaignEnd">
          <div class="weui-loading"></div>
          <div class="weui-loadmore__tips">正在加载</div>
        </div>
        <div class="loadEnd weui-loadmore__tips" v-else>---- 加载完毕 ----</div>
      </div>
    </scroll>
  </div>
</template>
<style scoped lang="less">
@charset "utf-8";
@rpx: 117.188rem;
  #find{
    box-sizing: border-box;
    height:100vh;
    .navigator{
      width: 100%;
      height: 100/@rpx;
      line-height: 100/@rpx;
      display: flex;
      justify-content: space-around;
      box-shadow: 0px 0px 8/@rpx 0px rgba(234,96,122,0.2) ;
      position:fixed;
      top:0;
      background: #fff;
      z-index: 4;
      .showContentBtn{
        color:#575757;
        span{
          font-size: 32/@rpx;
        }
      }
      .showContentBtn.active{
        color:#EA607A;
        border-bottom: 6/@rpx solid #EA607A;
      }
    }
    .wrapper{
      height: 100vh;
    }
    .listContainer{
      padding:120/@rpx 20/@rpx 120/@rpx 20/@rpx;
      .newsItem{
        width: 100%;
        height:420/@rpx;
        box-shadow:  0/@rpx 0/@rpx 8/@rpx 0px rgba(234,96,122,0.2) ;
        border-radius: 10/@rpx;
        margin-bottom: 20/@rpx;
        .title{
          font-size: 32/@rpx;
          color:#575757;
          width: 100%;
          height:60/@rpx;
          span{
            border:1/@rpx solid #EFB019;
            // width: 120/@rpx;
            padding: 0 14/@rpx;
            height:40/@rpx;
            line-height: 40/@rpx;
            font-size: 20/@rpx;
            display: inline-block;
            text-align: center;
            border-radius: 8/@rpx;
            vertical-align: top;
          }
        }
        img{
          width: 100%;
          height: 340/@rpx;
          border-radius: 8/@rpx;
        }
        .introduce{
          text-align: left;
          float: left;
          color:#575757;
          font-size: 32/@rpx;
          font-weight: 500;
          width:400/@rpx;
          overflow:hidden;
          text-overflow:ellipsis;
          white-space: nowrap;
          height: 46/@rpx;
          display: inline-block;
          padding-left: 10/@rpx;
          .yellow{
          color:#EFB019;
          margin-left: 10/@rpx;
          }
          .blue{
            color:#48A1DA;
            border:1/@rpx solid #48A1DA;
            margin-left: 10/@rpx;
          }
          .pink{
            font-size: 20/@rpx;
            color:#EA607A;
            border:1/@rpx solid #EA607A;
            margin-left: 10/@rpx;
          }
          span {
            margin-top: 3/@rpx;
          }
        }
        .time{
          float: right;
          color:#919191;
          font-size: 22/@rpx;
          vertical-align: bottom;
          height: 46/@rpx;
          line-height: 46/@rpx;
          display: inline-block;
          padding-right: 10/@rpx;
        }
      }
      .loadEnd{
        width: 100%;
        text-align: center;
        color:#919191;
        font-size: 24/@rpx;
      }
    }
    .city{
      .newsItem{
        height:460/@rpx;
        .name{
          color:#EA607A;
          font-size: 26/@rpx;
        }
      }
    }
  }
</style>

<script>
// import wx from 'wx'
import wx from '@/utils/wxSimulate.js'
import api from '@/utils/api'
import scroll from '@/subComponents/scroll'
export default {
  data () {
    return {
      current: 0,
      newsMsg: [],
      campaignMsg: [],
      activeBar: 0,
      changeBarActive: true, // 用于控制顶部tab栏进行侧滑的开关
      winHeight: '', // 窗口高度TODO:转H5修改获取方法
      newsPageNO: 1,
      campaignPageNO: 1,
      isNewsEnd: false,
      isCampaignEnd: false,
      soon_auction_ul: [],
      pulldown: true,
      num_: 0,
      xianshi: '已无更多数据',
      xianshi2: '加载完成',
      shifou: false,
      shifou2: false
    }
  },
  components: {
    scroll
  },
  methods: {
    // 0发布会 1同城
    changeBar (num) {
      this.findInit()
      this.activeBar = num
      this.current = num
      this.changeBarActive = true
      if (num === 0) {
        this.loadNewsData()
      } else {
        this.getCampaignList()
      }
    },
    // 发布会栏触底事件,暂时直接拼接数组模拟分页
    conferenceLower () {
      if (!this.isNewsEnd) {
        this.getNewsList()
      }
    },
    // 活动栏触底事件
    eventLower () {
      if (!this.isCampaignEnd) {
        this.getCampaignList()
      }
    },
    // 获取发布会列表
    async loadNewsData () {
      if (!this.isNewsEnd) {
        const newsInfo = await api.getDiscoverInfo(this.newsPageNO, 2)
        this.newsMsg = this.newsMsg.concat(newsInfo.pageInfo.list)
        if (!newsInfo.pageInfo.isLastPage) {
          this.newsPageNO++
        } else {
          this.isNewsEnd = true
          console.log('eeeeeeeeeeeeeeend')
          console.log(this.isNewsEnd)
        }
      }
    },
    // 获取活动列表
    async getCampaignList () {
      if (!this.isCampaignEnd) {
        const cityActivities = await api.getDiscoverInfo(this.campaignPageNO, 1)
        this.campaignMsg = this.campaignMsg.concat(cityActivities.pageInfo.list)
        console.log(this.campaignMsg)
        if (!cityActivities.pageInfo.isLastPage) {
          this.campaignPageNO++
        } else {
          this.isCampaignEnd = true
        }
      }
    },
    // 重置
    findInit () {
      console.log('unload')
      this.current = 0
      this.newsMsg = []
      this.campaignMsg = []
      this.activeBar = 0
      this.changeBarActive = true
      this.winHeight = ''
      this.newsPageNO = 1
      this.campaignPageNO = 1
      this.isNewsEnd = false
      this.isCampaignEnd = false
    },
    // 去发布会
    toConference (id) {
      wx.navigateTo({
        url: `/purchaseProcess/conferenceDetail/${id}`
      })
    },
    // 去活动详情
    toEventDetail (id) {
      wx.navigateTo({
        url: `/purchaseProcess/eventDetail/${id}`
      })
    }
  },
  created () {
    this.loadNewsData()
  },
  mounted () {
    console.log('mmmmmmmmmmmmmmmounted')
  }
}
</script>
